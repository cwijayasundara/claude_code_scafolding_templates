"""Markdown report generation from research findings."""

import logging
from datetime import UTC, datetime

logger = logging.getLogger(__name__)

DATE_FORMAT = "%Y-%m-%dT%H:%M:%S%z"
REPORT_TITLE_PREFIX = "Research Report"
ATTRIBUTION = "Generated by Deep Research Agent v2"


def generate_report(
    topic: str,
    findings: str,
    model_name: str,
    timestamp: datetime | None = None,
) -> str:
    """Generate a structured Markdown report from research findings.

    Args:
        topic: The research topic.
        findings: Raw findings text from the research agent.
        model_name: The LLM model identifier used for research.
        timestamp: Optional timestamp for the report. Defaults to now (UTC).

    Returns:
        A formatted Markdown report string.
    """
    if timestamp is None:
        timestamp = datetime.now(UTC)

    formatted_time = timestamp.strftime(DATE_FORMAT)
    logger.info("Generating report for topic: %s", topic)

    report = _build_report(topic, findings, model_name, formatted_time)
    logger.info("Report generated successfully (%d characters)", len(report))
    return report


def _build_report(
    topic: str,
    findings: str,
    model_name: str,
    formatted_time: str,
) -> str:
    """Build the Markdown report string.

    Args:
        topic: The research topic.
        findings: Raw findings text from the research agent.
        model_name: The LLM model identifier.
        formatted_time: Pre-formatted timestamp string.

    Returns:
        The assembled Markdown report.
    """
    sections = [
        f"# {REPORT_TITLE_PREFIX}: {topic}",
        "",
        f"**Date:** {formatted_time}  ",
        f"**Model:** {model_name}",
        "",
        "---",
        "",
        findings if findings.strip() else "_No findings available._",
        "",
        "---",
        "",
        f"_{ATTRIBUTION} | {formatted_time}_",
    ]
    return "\n".join(sections) + "\n"
